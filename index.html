<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0a0a0f">
<meta name="mobile-web-app-capable" content="yes">
<title>VozMail</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  :root { --bg:#0a0a0f; --surface:#13131a; --border:#1e1e2e; --accent:#e8ff57; --text:#e8e8f0; --muted:#5a5a7a; --red:#ff4444; }
  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  body { background:var(--bg); color:var(--text); font-family:'Syne',sans-serif; min-height:100dvh; display:flex; flex-direction:column; align-items:center; padding:36px 20px 40px; }
  body::before { content:''; position:fixed; inset:0; background:radial-gradient(ellipse 60% 40% at 50% 0%, rgba(232,255,87,0.04) 0%, transparent 70%); pointer-events:none; z-index:0; }
  .content { position:relative; z-index:1; width:100%; max-width:420px; display:flex; flex-direction:column; align-items:center; }
  header { width:100%; display:flex; align-items:center; justify-content:space-between; margin-bottom:28px; }
  .logo { font-size:24px; font-weight:800; letter-spacing:-0.5px; }
  .logo span { color:var(--accent); }
  .email-badge { font-family:'DM Mono',monospace; font-size:10px; color:var(--muted); background:var(--surface); border:1px solid var(--border); padding:6px 12px; border-radius:20px; max-width:175px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .transcript-area { width:100%; background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:20px; min-height:150px; max-height:220px; overflow-y:auto; margin-bottom:20px; transition:border-color 0.3s; }
  .transcript-area.has-text { border-color:rgba(232,255,87,0.25); }
  .transcript-placeholder { font-family:'DM Mono',monospace; font-size:13px; color:var(--muted); font-style:italic; line-height:1.7; }
  .transcript-text { font-family:'DM Mono',monospace; font-size:15px; line-height:1.7; white-space:pre-wrap; word-break:break-word; }
  .interim { color:var(--muted); font-style:italic; }
  .status { font-family:'DM Mono',monospace; font-size:13px; color:var(--muted); margin-bottom:24px; height:22px; display:flex; align-items:center; gap:8px; }
  .status-dot { width:7px; height:7px; border-radius:50%; background:var(--muted); flex-shrink:0; transition:all 0.3s; }
  .status.recording .status-dot { background:var(--red); animation:pulse 1.2s infinite; }
  .status.recording span { color:var(--red); }
  .status.ready .status-dot { background:var(--accent); }
  .status.ready span { color:var(--accent); }
  @keyframes pulse { 0%,100%{box-shadow:0 0 0 0 rgba(255,68,68,0.4)} 50%{box-shadow:0 0 0 6px rgba(255,68,68,0)} }
  .mic-btn { width:100%; height:80px; border-radius:40px; background:var(--red); border:none; display:flex; align-items:center; justify-content:center; gap:14px; cursor:pointer; outline:none; transition:all 0.2s; margin-bottom:14px; font-family:'Syne',sans-serif; font-size:17px; font-weight:800; color:#fff; }
  .mic-btn.recording { background:var(--surface); border:2px solid var(--red); color:var(--red); }
  .mic-btn:active { transform:scale(0.97); }
  .waveform { display:none; align-items:center; gap:3px; height:22px; }
  .mic-btn.recording .waveform { display:flex; }
  .mic-btn.recording .btn-static { display:none; }
  .wave-bar { width:3px; background:var(--red); border-radius:2px; animation:wave 1.2s ease-in-out infinite; }
  .wave-bar:nth-child(1){height:6px;animation-delay:0s} .wave-bar:nth-child(2){height:14px;animation-delay:.1s} .wave-bar:nth-child(3){height:20px;animation-delay:.2s} .wave-bar:nth-child(4){height:12px;animation-delay:.3s} .wave-bar:nth-child(5){height:18px;animation-delay:.15s}
  @keyframes wave { 0%,100%{transform:scaleY(0.4)} 50%{transform:scaleY(1)} }
  .subject-preview { width:100%; background:rgba(232,255,87,0.04); border:1px solid rgba(232,255,87,0.15); border-radius:12px; padding:14px 18px; margin-bottom:14px; display:none; }
  .subject-preview.visible { display:block; }
  .subject-label { font-family:'DM Mono',monospace; font-size:10px; letter-spacing:.15em; text-transform:uppercase; color:var(--accent); margin-bottom:6px; display:block; }
  .subject-value { font-size:14px; font-weight:600; line-height:1.4; }
  .send-btn { width:100%; padding:20px; background:var(--accent); color:#0a0a0f; border:none; border-radius:14px; font-family:'Syne',sans-serif; font-size:17px; font-weight:800; cursor:pointer; display:none; align-items:center; justify-content:center; gap:10px; outline:none; transition:all 0.2s; margin-bottom:12px; }
  .send-btn.visible { display:flex; }
  .send-btn:active { transform:scale(0.97); }
  .clear-btn { width:100%; padding:14px; background:transparent; color:var(--muted); border:1px solid var(--border); border-radius:14px; font-family:'DM Mono',monospace; font-size:13px; cursor:pointer; display:none; transition:all 0.2s; }
  .clear-btn.visible { display:block; }
  .error-box { width:100%; background:rgba(255,107,107,0.06); border:1px solid rgba(255,107,107,0.2); border-radius:12px; padding:14px 18px; margin-bottom:14px; display:none; }
  .error-box.visible { display:block; }
  .error-text { font-family:'DM Mono',monospace; font-size:12px; color:#ff6b6b; line-height:1.8; white-space:pre-wrap; }
  .toast { position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(20px); background:var(--surface); border:1px solid var(--border); color:var(--text); font-family:'DM Mono',monospace; font-size:13px; padding:12px 20px; border-radius:24px; opacity:0; transition:all 0.3s; white-space:nowrap; z-index:200; pointer-events:none; }
  .toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
</style>
</head>
<body>
<div class="toast" id="toast"></div>
<div class="content">
  <header>
    <div class="logo">Voz<span>Mail</span></div>
    <div class="email-badge">lateoriadelvideojuego@gmail.com</div>
  </header>
  <div class="transcript-area" id="transcriptArea">
    <div class="transcript-placeholder" id="placeholder">Pulsa el botón rojo, habla y vuelve a pulsar para parar.</div>
    <div class="transcript-text" id="transcriptText"></div>
  </div>
  <div class="status" id="status">
    <div class="status-dot"></div>
    <span id="statusMsg">Listo para grabar</span>
  </div>
  <button class="mic-btn" id="micBtn" onclick="toggleRecording()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
      <rect x="9" y="2" width="6" height="11" rx="3" fill="white"/>
      <path d="M5 11C5 14.866 8.134 18 12 18C15.866 18 19 14.866 19 11" stroke="white" stroke-width="2" stroke-linecap="round"/>
      <path d="M12 18V22M9 22H15" stroke="white" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <span class="btn-static">● Grabar</span>
    <span class="waveform">
      <span class="wave-bar"></span><span class="wave-bar"></span>
      <span class="wave-bar"></span><span class="wave-bar"></span>
      <span class="wave-bar"></span>
    </span>
  </button>
  <div class="error-box" id="errorBox"><div class="error-text" id="errorText"></div></div>
  <div class="subject-preview" id="subjectPreview">
    <span class="subject-label">Asunto del email</span>
    <div class="subject-value" id="subjectValue"></div>
  </div>
  <button class="send-btn" id="sendBtn" onclick="sendEmail()">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
      <path d="M22 2L11 13M22 2L15 22L11 13L2 9L22 2Z" stroke="#0a0a0f" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    Enviar por Email
  </button>
  <button class="clear-btn" id="clearBtn" onclick="clearAll()">✕ Borrar y repetir</button>
</div>

<script>
const USER_EMAIL = 'lateoriadelvideojuego@gmail.com';
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;

let isRecording = false;
let recognition = null;

// Acumulamos SOLO frases finales aquí, nunca se resetea durante la sesión
let accumulatedFinal = '';

function toggleRecording() {
  if (isRecording) {
    stopRecording();
  } else {
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(s => { s.getTracks().forEach(t => t.stop()); startRecording(); })
      .catch(err => showError('Micrófono bloqueado: ' + err.name));
  }
}

function startRecording() {
  accumulatedFinal = '';
  clearTranscript();
  hideResults();
  hideError();
  isRecording = true;
  document.getElementById('micBtn').classList.add('recording');
  setStatus('Grabando... pulsa de nuevo para parar', 'recording');
  launchRecognition();
}

function launchRecognition() {
  if (!SR) { showError('Usa Google Chrome.'); return; }

  recognition = new SR();
  // continuous: FALSE — cada sesión termina sola tras silencio, sin acumular
  recognition.continuous = false;
  recognition.interimResults = true;
  recognition.lang = navigator.language || 'es-ES';

  // Lo que llegó como FINAL en ESTA sesión
  let thisFinal = '';

  recognition.onresult = (e) => {
    thisFinal = '';
    let interim = '';
    for (let i = 0; i < e.results.length; i++) {
      if (e.results[i].isFinal) thisFinal += e.results[i][0].transcript + ' ';
      else interim += e.results[i][0].transcript;
    }
    // Mostrar: lo acumulado de sesiones anteriores + esta sesión + interim
    renderTranscript(accumulatedFinal + thisFinal, interim);
  };

  recognition.onerror = (e) => {
    if (e.error === 'no-speech') {
      // Silencio — guardar lo de esta sesión y relanzar si sigue grabando
      accumulatedFinal += thisFinal;
      thisFinal = '';
      if (isRecording) launchRecognition();
      return;
    }
    showError('Error: ' + e.error);
    forceStop();
  };

  recognition.onend = () => {
    // Guardar frases finales de esta sesión
    accumulatedFinal += thisFinal;
    thisFinal = '';
    // Si el usuario no ha pulsado parar, relanzar
    if (isRecording) launchRecognition();
  };

  try { recognition.start(); }
  catch(e) { showError('Error: ' + e.message); }
}

function stopRecording() {
  isRecording = false;
  document.getElementById('micBtn').classList.remove('recording');
  if (recognition) { recognition.onend = null; recognition.onerror = null; try { recognition.stop(); } catch(e){} }
  const text = accumulatedFinal.trim();
  if (text) {
    setStatus('Mensaje listo ✓', 'ready');
    showResults(text);
  } else {
    setStatus('Nada captado, inténtalo de nuevo', '');
  }
}

function forceStop() {
  isRecording = false;
  document.getElementById('micBtn').classList.remove('recording');
  if (recognition) { recognition.onend = null; recognition.onerror = null; try { recognition.stop(); } catch(e){} }
  setStatus('Listo para grabar', '');
}

function renderTranscript(final, interim) {
  const el = document.getElementById('transcriptText');
  const ph = document.getElementById('placeholder');
  const area = document.getElementById('transcriptArea');
  if ((final + interim).trim()) {
    el.innerHTML = final + (interim ? '<span class="interim">' + interim + '</span>' : '');
    ph.style.display = 'none';
    area.classList.add('has-text');
    area.scrollTop = area.scrollHeight;
  }
}

function clearTranscript() {
  document.getElementById('transcriptText').innerHTML = '';
  document.getElementById('placeholder').style.display = 'block';
  document.getElementById('transcriptArea').classList.remove('has-text');
}

function showResults(text) {
  document.getElementById('subjectValue').textContent = generateSubject(text);
  document.getElementById('subjectPreview').classList.add('visible');
  document.getElementById('sendBtn').classList.add('visible');
  document.getElementById('clearBtn').classList.add('visible');
}

function hideResults() {
  ['subjectPreview','sendBtn','clearBtn'].forEach(id => document.getElementById(id).classList.remove('visible'));
}

// Generador de asunto inteligente local
function generateSubject(text) {
  const clean = text.trim().replace(/\s+/g, ' ');

  // Palabras vacías en español
  const stopwords = new Set(['el','la','los','las','un','una','unos','unas','de','del','al','a','en','con','por','para','que','se','me','te','le','nos','lo','y','o','pero','si','como','cuando','donde','ya','hay','esto','esta','ese','esa','es','era','ser','estar','he','ha','han','hemos','muy','más','bien','todo','toda','también','porque','sobre','desde','hasta','sin','entre','con','mi','tu','su','mis','tus','sus','yo','tú','él','ella','nosotros','ellos','esto','eso','aquí','ahí','allí','qué','quién','cómo','cuándo','dónde','no','sí']);

  // Extraer palabras con contenido (>3 letras, no stopwords)
  const words = clean.toLowerCase()
    .replace(/[^a-záéíóúüñ\s]/gi, '')
    .split(' ')
    .filter(w => w.length > 3 && !stopwords.has(w));

  // Frecuencia de palabras
  const freq = {};
  words.forEach(w => freq[w] = (freq[w] || 0) + 1);

  // Top 4 palabras más frecuentes/importantes
  const top = Object.entries(freq)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 4)
    .map(([w]) => w);

  if (top.length === 0) {
    // Fallback: primera frase corta
    const first = clean.match(/[^.!?]+/)?.[0]?.trim() || clean;
    return cap(first.length > 60 ? first.substring(0, 57) + '…' : first);
  }

  // Construir asunto con las palabras clave en orden de aparición
  const ordered = words
    .filter((w, i, arr) => top.includes(w) && arr.indexOf(w) === i)
    .slice(0, 5);

  return cap(ordered.join(' '));
}

function cap(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

function sendEmail() {
  const text = accumulatedFinal.trim();
  if (!text) return;
  const subject = document.getElementById('subjectValue').textContent;
  const date = new Date().toLocaleDateString('es-ES',{weekday:'long',year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'});
  const body = `${text}\n\n—\nMensaje de voz grabado el ${date}\nVía VozMail`;
  window.location.href = `mailto:${encodeURIComponent(USER_EMAIL)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  showToast('Abriendo Gmail...');
}

function clearAll() {
  accumulatedFinal = '';
  clearTranscript();
  hideResults();
  hideError();
  setStatus('Listo para grabar', '');
}

function setStatus(msg, type) {
  document.getElementById('statusMsg').textContent = msg;
  document.getElementById('status').className = 'status ' + type;
}

function showError(msg) {
  document.getElementById('errorText').textContent = msg;
  document.getElementById('errorBox').classList.add('visible');
}

function hideError() { document.getElementById('errorBox').classList.remove('visible'); }

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}
</script>
</body>
</html>
